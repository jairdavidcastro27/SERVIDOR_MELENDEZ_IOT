<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Sesiones</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .sesion-activa {
            background-color: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .datos-sesion {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .stats-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .stat-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .stat-box h5 {
            margin: 0 0 10px 0;
            color: #0056b3;
        }
        .data-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .data-table th {
            background-color: #007bff;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gestión de Sesiones</h1>
            <nav style="margin-bottom: 20px;">
                <button onclick="window.location.href='/monitor/'" class="btn btn-primary">Volver al Monitor</button>
            </nav>
        </div>

        <div id="sesionActiva" class="sesion-activa">
            <h2>Sesión Activa</h2>
            <div id="sesionActivaContent">
                Cargando...
            </div>
        </div>

        <h2>Histórico de Sesiones</h2>
        <table>
            <thead>
                <tr>
                    <th>Paciente</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="sesionesBody">
            </tbody>
        </table>

        <div id="datosSesion" class="datos-sesion">
            <h3>Datos de la Sesión</h3>
            <div id="datosSesionContent"></div>
        </div>
    </div>

    <script>
        // Verificar autenticación
        if (!localStorage.getItem('token')) {
            window.location.href = '/login_cuidador/';
        }

        const token = localStorage.getItem('token');

        // Cargar datos al iniciar
        window.onload = function() {
            loadSesionActiva();
            loadSesiones();
        }

        // Cargar sesión activa
        async function loadSesionActiva() {
            try {
                const response = await fetch('/api/paciente-actual/', {
                    headers: {
                        'Authorization': `Token ${token}`
                    }
                });
                const data = await response.json();
                
                const content = document.getElementById('sesionActivaContent');
                if (data.mensaje) {
                    content.innerHTML = '<p>' + data.mensaje + '</p>';
                } else {
                    content.innerHTML = `
                        <p><strong>Paciente:</strong> ${data.paciente.nombre} ${data.paciente.apellido}</p>
                        <p><strong>Inicio:</strong> ${new Date(data.inicio).toLocaleString()}</p>
                        <button class="btn btn-danger" onclick="finalizarSesion()">Finalizar Sesión</button>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Cargar todas las sesiones
        async function loadSesiones() {
            try {
                const response = await fetch('/api/sesiones/', {
                    headers: {
                        'Authorization': `Token ${token}`
                    }
                });
                const sesiones = await response.json();
                displaySesiones(sesiones);
            } catch (error) {
                console.error('Error:', error);
            }
        }

            // Mostrar sesiones en la tabla
        function displaySesiones(sesiones) {
            const tbody = document.getElementById('sesionesBody');
            tbody.innerHTML = '';
            
            sesiones.forEach(sesion => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${sesion.paciente_nombre}</td>
                    <td>${new Date(sesion.inicio).toLocaleString()}</td>
                    <td>${sesion.fin ? new Date(sesion.fin).toLocaleString() : '-'}</td>
                    <td>${sesion.activa ? 'Activa' : 'Finalizada'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="event.preventDefault(); verDatosSesion(${sesion.id})">Ver Datos</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Finalizar sesión activa
        async function finalizarSesion() {
            if (confirm('¿Estás seguro de que deseas finalizar la sesión actual?')) {
                try {
                    await fetch('/api/sesiones/finalizar_activa/', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Token ${token}`
                        }
                    });
                    loadSesionActiva();
                    loadSesiones();
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        }

        // Ver datos de una sesión
        async function verDatosSesion(id) {
            // Prevenir comportamiento por defecto si viene de un evento
            if (event) {
                event.preventDefault();
            }

            const datosDiv = document.getElementById('datosSesion');
            const content = document.getElementById('datosSesionContent');
            
            // Desplazar a la sección de datos
            datosDiv.scrollIntoView({ behavior: 'smooth' });
            
            // Mostrar mensaje de carga
            datosDiv.style.display = 'block';
            content.innerHTML = '<div class="loading">Cargando datos de la sesión...</div>';

            try {
                // Primero, cargar las estadísticas
                const statsResponse = await fetch(`/api/sesiones/${id}/estadisticas/`, {
                    headers: {
                        'Authorization': `Token ${token}`
                    }
                });
                const stats = await statsResponse.json();

                // Luego, cargar los datos detallados
                const dataResponse = await fetch(`/api/sesiones/${id}/datos/`, {
                    headers: {
                        'Authorization': `Token ${token}`
                    }
                });
                const response = await dataResponse.json();
                const datos = response.datos;
                
                const datosDiv = document.getElementById('datosSesion');
                const content = document.getElementById('datosSesionContent');
                
                // Mostrar estadísticas
                let statsHtml = `
                    <div class="stats-container">
                        <h4>Estadísticas de la Sesión</h4>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <h5>Temperatura</h5>
                                <p><strong>Mínima:</strong> ${stats.temperatura.min.toFixed(2)}°C</p>
                                <p><strong>Máxima:</strong> ${stats.temperatura.max.toFixed(2)}°C</p>
                                <p><strong>Promedio:</strong> ${stats.temperatura.avg.toFixed(2)}°C</p>
                            </div>
                            <div class="stat-box">
                                <h5>Distancia</h5>
                                <p><strong>Mínima:</strong> ${stats.distancia.min.toFixed(2)} cm</p>
                                <p><strong>Máxima:</strong> ${stats.distancia.max.toFixed(2)} cm</p>
                                <p><strong>Promedio:</strong> ${stats.distancia.avg.toFixed(2)} cm</p>
                            </div>
                            <div class="stat-box">
                                <h5>Información General</h5>
                                <p><strong>Duración:</strong> ${Math.round(stats.duracion_minutos)} minutos</p>
                                <p><strong>Total de registros:</strong> ${stats.total_registros}</p>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="datosChart"></canvas>
                        </div>
                    </div>
                `;

                // Mostrar datos detallados
                if (datos.length === 0) {
                    content.innerHTML = statsHtml + '<div class="error-message">No hay datos registrados para esta sesión.</div>';
                } else {
                    // Preparar datos para la gráfica
                    const timestamps = datos.map(d => new Date(d.timestamp).toLocaleTimeString());
                    const temperaturas = datos.map(d => d.temperatura);
                    const distancias = datos.map(d => d.distancia);

                    let tableHtml = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Temperatura</th>
                                    <th>Distancia</th>
                                    <th>Nivel</th>
                                    <th>Color</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    datos.forEach(dato => {
                        tableHtml += `
                            <tr>
                                <td>${new Date(dato.timestamp).toLocaleString()}</td>
                                <td>${dato.temperatura.toFixed(2)}°C</td>
                                <td>${dato.distancia.toFixed(2)} cm</td>
                                <td>${dato.nivel}</td>
                                <td>${dato.color}</td>
                            </tr>
                        `;
                    });
                    tableHtml += '</table>';
                    content.innerHTML = statsHtml + tableHtml;

                    // Crear la gráfica
                    const ctx = document.getElementById('datosChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: timestamps,
                            datasets: [
                                {
                                    label: 'Temperatura (°C)',
                                    data: temperaturas,
                                    borderColor: 'rgb(255, 99, 132)',
                                    tension: 0.1,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Distancia (cm)',
                                    data: distancias,
                                    borderColor: 'rgb(54, 162, 235)',
                                    tension: 0.1,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Temperatura (°C)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Distancia (cm)'
                                    }
                                }
                            }
                        }
                    });
                }
                
                datosDiv.style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = '<div class="error-message">Error al cargar los datos: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>